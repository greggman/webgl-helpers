<script src="../webgl-gl-error-check.js"></script>
<p>see JavaScript console</p>
<canvas></canvas>
<script type="module">
import * as twgl from './js/twgl-full.module.js';

const gl = document.querySelector('canvas').getContext('webgl');

const vs = `
attribute vec4 position;
attribute vec2 texcoord;
attribute vec4 color;

varying vec4 v_color;
varying vec2 v_texcoord;

void main() {
  gl_Position = position;
  v_color = color;
  v_texcoord = texcoord;
}
`;

const fs = `
precision mediump float;

varying vec4 v_color;
varying vec2 v_texcoord;

uniform sampler2D u_diffuse;

void main() {
  gl_FragColor = texture2D(u_diffuse, v_texcoord) * v_color;
}
`;

const prg = twgl.createProgram(gl, [vs, fs]);

const tex = gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D, tex);
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);

function makeBuffer(gl, data, target = gl.ARRAY_BUFFER) {
  gl.bindBuffer(target, gl.createBuffer());
  gl.bufferData(target, data, gl.STATIC_DRAW);
}

function makeBufferAndSetAttrib(gl, prg, name, size, data) {
  makeBuffer(gl, data);
  const loc = gl.getAttribLocation(prg, name);
  gl.enableVertexAttribArray(loc);
  gl.vertexAttribPointer(loc, size, gl.FLOAT, false, 0, 0);
}

const positions = new Float32Array([0, 0, 1, 0, 0, 1]);
const texcoords = new Float32Array([0, 0, 1, 0, 0, 1]);
const colors = new Float32Array([1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1]);
const indices = new Uint16Array([0, 1, 3]);  // 3 is out of bounds

makeBufferAndSetAttrib(gl, prg, 'position', 2, positions);
makeBufferAndSetAttrib(gl, prg, 'texcoord', 2, texcoords);
makeBufferAndSetAttrib(gl, prg, 'color', 4, colors);
makeBuffer(gl, indices, gl.ELEMENT_ARRAY_BUFFER);

gl.useProgram(prg);
gl.drawElements(gl.TRIANGLES, 3, gl.UNSIGNED_SHORT, 0); // buffer overflow
</script>

